<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Talk to our AI Agent</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root { --blue:#2f64e1; --green:#22c55e; --red:#ef4444; --ink:#0b1220; --paper:#0f172a; --text:#e5e7eb; }
    body { margin:0; background:var(--paper); color:var(--text);
      font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      display:grid; place-items:center; padding:28px; }
    .card { width:min(860px,94vw); background:#0c1324; border:1px solid rgba(255,255,255,.08);
            border-radius:16px; padding:22px; box-shadow:0 10px 35px rgba(0,0,0,.35); }
    h1 { margin:0 0 10px; font-size:22px; }
    .note { background:var(--blue); color:#fff; display:inline-block; padding:8px 12px; border-radius:6px; }
    .row { margin:16px 0; display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    button { padding:12px 18px; border-radius:12px; font-size:16px; border:none; cursor:pointer; color:#fff; }
    #callBtn { background:var(--green); }
    #hangBtn { background:var(--red); display:none; }
    #status { margin-top:8px; opacity:.95; }
    #log { margin-top:14px; display:none; background:var(--ink); color:#e5e7eb; padding:12px;
           border-radius:10px; overflow:auto; max-height:40vh; }
    .pill { font-size:12px; background:#1b2a55; border:1px solid #274080; border-radius:999px; padding:4px 8px; margin-left:8px }
  </style>
</head>
<body>
  <main class="card">
    <h1>Talk to Jane, the ImpactAgent voice agent <span id="sdkSource" class="pill" style="display:none"></span></h1>
    <div class="note">Click "Start Call", then **ALLOW microphone access** when prompted. If no prompt appears, click the lock icon in your browser's address bar and enable microphone permissions.</div>


    <div class="row">
      <button id="callBtn">Start Call</button>
      <button id="hangBtn">Hang Up</button>
      <span id="status">Loading agent…</span>
    </div>

    <pre id="log"></pre>
  </main>

  <!-- Everything below runs as an ES module (browser-native; no require()). -->
  <script type="module">
    // ✅ Import browser bundle with dependencies inlined.
    import { RetellWebClient } from "https://esm.sh/retell-client-js-sdk@2.0.7?bundle";

    // ---- Config: your Cloudflare Worker that returns {access_token, call_id}
    const MINT_URL = "https://peas-voice-agent.jocelyn-379.workers.dev/";

    // ---- UI helpers
    const statusEl = document.getElementById('status');
    const logEl = document.getElementById('log');
    const callBtn = document.getElementById('callBtn');
    const hangBtn = document.getElementById('hangBtn');
    const sdkSource = document.getElementById('sdkSource');

    function setStatus(t){ statusEl.textContent = t; }
    function log(){ /* no on-page logging */ }

    // ---- Init SDK client (ESM import gives you the class directly)
    let client = null;
    try {
      client = new RetellWebClient();
      setStatus("Ready.");
    } catch (e) {
      setStatus("Could not initialize the agent SDK.");
      log("Failed to construct RetellWebClient", { message: e.message });
    }

    // ---- Fetch token from Worker
    async function mintToken(){
      const r = await fetch(MINT_URL, { method:'POST' }); // preflight-free POST
      const text = await r.text();
      try { return JSON.parse(text); }
      catch(e){ log("Mint endpoint did not return JSON", text);
        throw new Error("Could not get a token. Check Worker/AGENT_ID/API key."); }
    }

    // ---- Call controls
    let inCall = false;
async function checkMicrophonePermission() {
  try {
    const permission = await navigator.permissions.query({ name: 'microphone' });
    if (permission.state === 'denied') {
      setStatus("Microphone blocked. Please enable microphone access in browser settings.");
      return false;
    }
    return true;
  } catch (e) {
    // Fallback: try to get user media directly
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      stream.getTracks().forEach(track => track.stop()); // Clean up
      return true;
    } catch (err) {
      setStatus("Microphone access required. Please allow when prompted.");
      return false;
    }
  }
}

    async function startCall(){
      try{
        if (!client) throw new Error("SDK not ready");
        
        // Add permission check
        const hasPermission = await checkMicrophonePermission();
        if (!hasPermission) return;
        
        callBtn.disabled = true;
        setStatus("Connecting… please allow microphone");
        log("POST to mint URL", { url: MINT_URL });

        const { access_token, call_id } = await mintToken();
        log("Got token", { call_id, access_token_preview:(access_token||'').slice(0,12)+"…" });
        if (!access_token) throw new Error("No access_token returned");

        await client.startCall({ accessToken: access_token });
        inCall = true;
        callBtn.style.display='none'; hangBtn.style.display='inline-block';
        setStatus("Connected. You can speak now.");
      } catch(e){
        setStatus(e.message || "Error starting call. See log.");
        log("startCall error", { message:e.message });
      } finally {
        callBtn.disabled = false;
      }
    }

    function endCall(){
      try{ client?.stopCall?.(); }catch(_){}
      inCall=false;
      hangBtn.style.display='none'; callBtn.style.display='inline-block';
      setStatus("Call ended.");
    }

    callBtn.addEventListener('click', ()=>{ if(!inCall) startCall(); });
    hangBtn.addEventListener('click', endCall);
  </script>
</body>
</html>

